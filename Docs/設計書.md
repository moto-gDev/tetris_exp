# テトリス・プログラム設計書

本ドキュメントは、仕様書に基づいたテトリスゲームのプログラム設計を定義します。
開発環境は **Godot Engine (GDScript)** を想定します。

## 1. 全体アーキテクチャ

ゲームは複数の「シーン」と、それらを統括する「ゲームオーバーレイ/マネージャー」で構成されます。

### シーン構成
- `Main.tscn`: ゲーム全体を統括するルートシーン。シーン遷移の管理を行う。
- `Title.tscn`: タイトル画面。
- `Game.tscn`: ゲームプレイ画面。
    - `Board`: フィールド（背景グリッドと固定済みブロック）。
    - `PieceManager`: アクティブなミノの制御。
    - `UI`: スコア、レベル、Next、Holdの表示。
- `OptionOverlay.tscn`: 音量設定などのオーバーレイ（CanvasLayer）。
- `Result.tscn`: リザルト画面。

### シングルトン (Autoload)
- `Global.gd`: ハイスコア、現在のレベル、設定情報の保持。
- `AudioManager.gd`: BGM/SEの再生管理。

---

## 2. 主要クラス設計

### GameManager (`Main.gd` / `Game.gd`)
ゲームの状態（State）を管理し、フローを制御します。
- `State`: `READY`, `PLAYING`, `PAUSED`, `GAMEOVER`, `RESULT`
- `start_game()`: カウントダウン開始からプレイ状態へ移行。
- `game_over()`: 終了判定。

### Board (`Board.gd`)
20x10のグリッド情報を管理します。
- `grid`: `Vector2` または整数値の2D配列。
- `is_colliding(piece_data, offset)`: 衝突判定。
- `lock_piece(piece_data)`: ミノをグリッドに固定。
- `clear_lines()`: ライン消去判定と消去処理。

### PieceManager (`PieceManager.gd`)
操作中のテトリミノを制御します。
- `current_piece`: 現在のミノデータ。
- `input_handler()`: 入力に応じた移動・回転。
- `apply_gravity()`: 自然落下。
- `spawn_piece()`: 新しいミノを生成。

### PieceGenerator (`PieceGenerator.gd`)
7-bagアルゴリズムによるミノ供給。
- `bag`: ミノのリスト。空になったらシャッフルされた7種を追加。
- `get_next_piece()`: 次のミノを返す。

---

## 3. データ構造とロジック

### テトリミノの定義
各ミノは、中心点からの相対座標リスト（`Vector2`）で定義します。
```gdscript
const PIECES = {
    "I": [Vector2(-1, 0), Vector2(0, 0), Vector2(1, 0), Vector2(2, 0)],
    "O": [Vector2(0, 0), Vector2(1, 0), Vector2(0, 1), Vector2(1, 1)],
    # ...他7種
}
```

### SRS (Super Rotation System)
回転の失敗時に試行する5つのオフセット位置をテーブルとして持ちます。
- 参照: [SRS Table](https://shiwehi.com/tetris/template/srs.php)
- `test_rotation(direction)`: オフセットを順に試し、衝突しない位置を探す。

### 7-bag生成
```gdscript
var current_bag = []
func get_next():
    if current_bag.is_empty():
        current_bag = ["I", "O", "T", "S", "Z", "J", "L"]
        current_bag.shuffle()
    return current_bag.pop_front()
```

---

## 4. UI・演出設計

### UIレイヤー
`CanvasLayer` を使用して、ゲーム画面の上に描画します。
- `Z-Index` 管理により、ポーズメニューを最前面に表示。

### 消去アニメーション
- `Tween` または `AnimationPlayer` を使用。
- ラインが揃った際、対象ブロックを点滅させてから削除し、上のブロックを `lerp` で移動。

---

## 5. セーブデータ

`ConfigFile` クラスを使用して、ユーザーディレクトリ（`user://`）に保存します。
- `settings.cfg`:
    - `[audio]` : `bgm_volume`, `se_volume`
    - `[score]` : `high_score`
